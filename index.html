<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <title>Timeline Jan Anthonie Bruijn</title>
  <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="d3.layout.timeline.js" charset="utf-8" type="text/javascript"></script>
  <style type="text/css">
  h1 {
    font: 25px sans-serif;
    margin-left: 20px;
    margin-top: 40px;
  }

  text {
    font: 10px sans-serif;
  }

  .axis text {
    font: 8px sans-serif;
  }

 .axis path {
  stroke-width: 0;
  stroke: #000;
 }

 .axis line {
  shape-rendering: crispEdges;
  stroke: #000;
  stroke-width: 1px;
}

.legendtitle {
  font: 12px sans-serif;
  font-weight: bold;
}

p.bgtexttime {
  width: 200px;
  font: 10px sans-serif;
  background-color: #FFF;
  padding: 5px;
  border: solid 1px;
}

.legend:hover {
  cursor: pointer;
  opacity: 0.5;
}

g.legend:hover{
    
  }

/*circle[id^=dot-]:hover {
  stroke: #000;
  stroke-width: 1;
}*/




  </style>
  <script type="text/javascript">
//example database: company,positionis,start,end,sector,sourceis,typeis
//"Educatie, Big Improvement Day","Lid kerngroep","01/01/2010","3/15/2016","Education","pdc","Organization"



var w = 900;
var h = 400;
var radius = 4;
var paddingdoc = 20;
var marginleft = 240;
var marginbottom = 200;
var htimeline = (w - marginleft) / 2

var idcounterdot = 0
var idcounterbar = 0
var idcountertxt = 0
var idcountertri = 0

var xPoint = function(d) {return ((d.end - d.start)/ 2) + d.start + paddingdoc + marginleft; }; // x top-triangle point
var yPoint = function(d) {return htimeline - ((d.end - d.start)/ 2) + paddingdoc ; }; // y top triangle point
var dxStart = function(d) {return d.start + paddingdoc + marginleft; }; // startpoint bar plus extra left padding
var dxEnd = function(d) {return d.end + paddingdoc + marginleft; }; // endpoint bar
var sectorfill = function(d) {return colorScale(d.sector); }; // color sector

var types = [];

colorScale = d3.scale.ordinal()
  .domain(types)
  .range(["#f1c7dd", "#0b326b", "#f5bd42", "#7bcbc0",   "#f05129",  "#b7cc94", "#e3337e", "#827775", "#966eac", "#b09977",]);

var timeline = d3.layout.timeline()
    .size([w - marginleft,htimeline])
    .extent(["01/01/1989", "3/15/2016"])
    .padding(4)
    .maxBandHeight(12); // height bands

// array sectors to determine colors -------> counter? Biggest first? 

var sectorTypes = function(dataset){
  dataset.forEach(function(data){
    if (types.indexOf(data.sector) === -1) {
      types.push(data.sector);
    }
  });
};

// draw Axes

var timeAxes = function(dataset) {
  // img timeline
  var svgContainer = d3.select("body")
    .append("svg")
    .attr({
      width: w + (2 * paddingdoc),
      height: htimeline + (2 * paddingdoc) + marginbottom
    })
    .style("border", "1px solid black")
    ;

  var showTimeAxis = true, // variable, meerdere vars door komma's
    beginning = 0,
    ending = 0,
    width = null,
    height = null,
    orient = "bottom"
    ;

  var dateFormat = d3.time.format('%m/%d/%Y');
  var timelinedataset = timeline(dataset); //draw bars & dots

  // scales & axes

  var xScaleTime = d3.time.scale() // input domain , output range
    .domain([d3.min(dataset, function(d) { return dateFormat.parse(d.start); }), d3.max(dataset, function(d) { return dateFormat.parse(d.end); })])
    .range([paddingdoc + marginleft, w + paddingdoc]);

  var xAxisTime = d3.svg.axis()
    .scale(xScaleTime)
    .orient("bottom") // text orient
    .ticks(d3.time.year, 1)
    .tickFormat(d3.time.format('%Y'))
    .tickSize(3, 1) // inner tick size(value, length ticks themselves), outer tick size(line-thickness axis)
    .tickPadding(6) // space between ticks and values
    ;

 var xAxisT = d3.select("svg")
    .append("g")
    .attr({
      "transform": "translate(0 ," + (htimeline + paddingdoc) + ")",
      "class": "x axis"
    })
    .call(xAxisTime)
    .append("text") 
    .text("Time in years")
    .attr("transform", "translate(" + (w - paddingdoc - 50) + " ," + (paddingdoc + 8) + ")")
    ;

  var yScaleTime = d3.scale.linear()
    .domain([0 , ((d3.max(dataset, function(d) { return dateFormat.parse(d.end); }) - d3.min(dataset, function(d) { return dateFormat.parse(d.start); })) / (1000 * 60 * 60 * 24 * 365))
      ])
    .range([htimeline + paddingdoc , paddingdoc])
    ;

  var yAxisTime = d3.svg.axis()
    .scale(yScaleTime)
    .orient("left")
    .ticks(8)
    .tickSize(3, 1)
    ;

var yAxisT = d3.select("svg")
    .append("g")
    .attr({
      "transform": "translate(" + (paddingdoc + marginleft) + ", 0 )",
      "class": "y axis"
    })
    .call(yAxisTime)
    .append("text") 
    .text("Duration in years")
    .attr({
        "x": -125,
        "y": -25,
        "transform": "rotate(-90)"
      });

var textlabelParty = d3.select("svg")
    .append("text") 
    .text("Political Party")
    .attr({
        "x": marginleft - 60,
        "y": paddingdoc + htimeline + 48 
      });

};

d3.csv("cvbruijn.csv", function (dataset) {

  /*
   var clean = dataset.map(function(d) {
    var cleanD = {};
    d3.keys(d).forEach(function(k) {
      cleanD[_.trim(k)] = _.trim(d[k]);
    });
    return cleanD;
  });

  console.log(JSON.stringify(clean));
  */ 

var determineSector = sectorTypes(dataset);

var drawAxes = timeAxes(dataset);

  //DRAW ELEMENTS: points, timelines, text connected to the points
  types.forEach(function(type, i) {
    onlyThisType = dataset.filter(function(d) {return d.sector === type});
    theseBands = timeline(onlyThisType);

    
    // bars

    var bars = d3.select("svg")
      .append("g")
      .selectAll("rect")
      .data(theseBands)
      .enter()
      .append("rect")
      .filter(function(d) {return d.typeis !== 'Political Party'})
      .attr({
        "x": dxStart,
        "y": htimeline + paddingdoc, // to move from top to bottom
        "height": function(d) {return d.dy; }, //meaning d.dy??
        "width": function(d) {return d.end - d.start; },
        "fill": sectorfill,
        "class": function(d) {return "bar-" + d.sector.replace(/\W/gi, '-').toLowerCase()},
        "id": function(d) {
          idcounterbar += 1;
          return "bar-" + idcounterbar; },
        "visibility": "hidden"
      })
      ;

    // political party bars

    var barparty = d3.select("svg")
      .append("g")
      .selectAll("rect")
      .data(theseBands)
      .enter()
      .append("rect")
      .filter(function(d) {return d.typeis === 'Political Party'})
      .attr({
        "x": dxStart,
        "y": function(d) {return 40 + htimeline + paddingdoc + d.y}, // positioning bars below each other in one category function (d) {return (h - d)}
        "height": function(d) {return d.dy; }, //
        "width": function(d) {return d.end - d.start; },
        "fill": d3.rgb("#AAA")
      })
      ;

    //text political party info

    var infoparty = d3.select("svg") 
      .append("g")
      .selectAll("text")
      .data(theseBands)
      .enter()
      .append("text")
      .filter(function(d) {return d.typeis === 'Political Party'})
      .text(function(d) {return d.company})
      .attr({
        "x": dxStart,
        "y": (function(d) {return 47 + htimeline + paddingdoc + d.y})
      })
      .style({
        "opacity": 0
      })
      ;

      //triangle 

    theseBands
      .filter(function(b) {
        return b.typeis !== 'Political Party';
      })
      .forEach(function(d) {
    
        var xPoint = ((d.end - d.start)/ 2) + d.start + paddingdoc + marginleft; // x top-triangle point
        var yPoint =  htimeline - ((d.end - d.start)/ 2)  + paddingdoc ;  // y top triangle point
        var dxStart = d.start + paddingdoc + marginleft;// startpoint bar plus extra left padding
        var dyBar = htimeline  + paddingdoc ; // to move from top to bottom
        var dxEnd = d.end + paddingdoc + marginleft; // endpoint bar

        var trianglePoints = [ { "x": dxStart,   "y": dyBar},  { "x": xPoint,   "y": yPoint}, { "x": dxEnd,   "y": dyBar} ];

        var lineFunction = d3.svg.line()
        .x(function(d) { return d.x; })
        .y(function(d) { return d.y; })
        .interpolate("linear"); // straight lines

        var triangle = d3.select("svg")
          .append("g")
          .selectAll("lines")
          .data([d])
          .enter()
          .append("path")
          .attr({
            "d": lineFunction(trianglePoints),
            "stroke": sectorfill,
            "stroke-width": 1,
            "fill-opacity": 0,
            "class": function(d) {return "tri-" + d.sector.replace(/\W/gi, '-').toLowerCase()},
            "id": function(d) {
              idcountertri += 1;
              return "tri-" + idcountertri; 
              },
            "visibility": "hidden"
            })
          .style({
            "stroke-dasharray": ("3, 3"),
          })
          ;
      })
    ;


    // dots

    var dots = d3.select("svg")
      .append("g")
      .selectAll("circle")
      .data(theseBands)

    ;

// transition werkt niet...

    dots.transition()
      // .delay(function(d, i) {
      //   return i * 100;
      //   })
      // .duration(3000)
      // .ease("linear")
      .attr({
        "r": radius, //radius
        "cx": xPoint, // startpoint
        "cy": yPoint, // positioning
        "fill": sectorfill,
          })
    ;
var show = ["#bar-", "#tri-", "#txt-"]
    dots.enter()
      .append("circle")
      .filter(function(d){return d.typeis !== 'Political Party'})
      .style({
        "opacity": 0.6,
        "cursor" : "pointer"
      })
      .attr({
        "r": radius, //radius
        "cx": xPoint, // startpoint
        "cy": yPoint, // positioning
        "fill": sectorfill,
        "class": function(d) {return "dot-" + d.sector.replace(/\W/gi, '-').toLowerCase()},
        "id": function(d) {
              idcounterdot += 1;
              return "dot-" + idcounterdot; 
              }
          })
      .on("mouseover", function(d) {
        var active = this.active ? true : false;
        var visibility = active ? "hidden" : "visible";
        var obj = this.id.substr(4,5);
        show.forEach(function(s){
          d3.select(s + obj).each(function() {  
        this.setAttribute("visibility", visibility);
            });
          });
      // .on("mouseover", function(d) {
      //   var active = this.active ? true : false;
      //   var opacity = active ? 0 : 1;
      //   d3.select("#bar-" + this.id.substr(4,5)).each(function() {
      //   this.style.opacity = opacity;
      //     })
      //   d3.select("#txt-" + this.id.substr(4,5)).each(function() {
      //   this.style.opacity = opacity;
      //     })
      //   d3.select("#tri-" + this.id.substr(4,5)).each(function() {
      //   this.style.opacity = opacity;
      //     })
        // })
      // .on("mouseout", function(d) {
      //   var active = this.active ? true : false;
      //   var visibility = active ? "visible" : "hidden";
      //   show.forEach(function(s){
      //     d3.select(s + this.id.substr(4,5)).forEach(function() {  
      //   this.setAttribute("visibility", visibility);
      //       });
      //     });
      // .on("mouseout", function(d) {
      //   var active = this.active ? true : false;
      //   var opacity = active ? 1 : 0;
      //   d3.select("#bar-" + this.id.substr(4,5)).each(function() {
      //   this.style.opacity = opacity;
      //     })
      //   d3.select("#txt-" + this.id.substr(4,5)).each(function() {
      //   this.style.opacity = opacity;
      //     })
      //   d3.select("#tri-" + this.id.substr(4,5)).each(function() {
      //   this.style.opacity = opacity;
      //     })
        })
      ;


    //texttimeline
    
    var texttimeline = d3.select("svg");
    texttimeline
      .append("g")
      .selectAll("text")
      .data(theseBands)
      .enter()
      .append("foreignObject")
      .filter(function(d) {return d.typeis !== 'Political Party'})
      .html(function(d) {
        return "<p class='bgtexttime'>Company: " + d.company + " <br/> Position: " + d.positionis + "</p>";
        })
      .attr({
        "x": xPoint,
        "y": yPoint,
        "fill": d3.rgb("#000"),
        "class": function(d) {return "txt-" + d.sector.replace(/\W/gi, '-').toLowerCase()},
        "id": function(d) {
          idcountertxt += 1;
          return "txt-" + idcountertxt; },
          "visibility": "hidden"
      })
      .each(function(d) {
        var bbox = this.getBBox();

        d3.select(this.parentNode)
          .insert("rect", "text")
          // .style("fill", "#FFF")
          // .style("stroke-width", 1)
          // .style("stroke", "#000")
          // .attr("x", bbox.x )
          // .attr("y", bbox.y )
          .attr("width", bbox.width + 1) 
          .attr("height", bbox.height + 1);
      })
      ;

  })

// legend
// todo: check if domain is not empty (because of moving the political party items)
  
  var legendRectSize = 15;
  var legendSpacing = 5;

  var legendtitle = d3.select("svg")
    .append("text")
    .text("Sectors")
    .attr({
      "class": "legendtitle",
      "x": paddingdoc,
      "y": paddingdoc + 6
    })
  ;

  var legendexplain = d3.select("svg")
    .append("text")
    .text("Click to show/hide")
    .attr({
      "class": "legendexplain",
      "x": paddingdoc,
      "y": paddingdoc * 2
    })
  ;

  var legend = d3.select("svg")
    .append("g")
    .selectAll("g")
    .data(colorScale.domain())
    .enter()
    .append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) {
        var height = legendRectSize;
        var x = paddingdoc;
        var y = (paddingdoc * 2.5) + i * (height + legendSpacing);
        return "translate(" + x + "," + y + ")";
      })
    ;

  legend.append("rect")
    .attr("width", legendRectSize)
    .attr("height", legendRectSize)
    .style("fill", colorScale)
    .style("stroke", colorScale)
    ;

  legend.append("text")
    .attr("x", legendRectSize + legendSpacing)
    .attr("y", legendRectSize - legendSpacing + 2)
    .text(function(d) { return d; })
    .on("click", function(d) {
      var active = this.active ? true : false;
      var opacity = active ? 0.6 : 0;
      this.active = !active;
      d3.selectAll('.dot-' + d.replace(/\W/gi, '-').toLowerCase()).each(function() {
        this.style.opacity = opacity;
      })
    ;

    })
  ;

});

</script>
</head>
<body>
<div id="viz">
  <h1>Timeline Jan Anthonie Bruijn</h1>

</div>
</body>
</html>
