<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <title>Timeline Jan Anthonie Bruijn</title>
  <script src="//d3js.org/d3.v3.min.js" charset="utf-8" type="text/javascript"></script>
  <script src="d3.layout.timeline.js" charset="utf-8" type="text/javascript"></script>
  <link href="style.css" rel="stylesheet" type="text/css">
  <style type="text/css"></style>
  
  <script src="measures.js" charset="utf-8" type="text/javascript"></script>
  <script type="text/javascript">
//example database: company,positionis,start,end,sector,sourceis,typeis
//"Educatie, Big Improvement Day","Lid kerngroep","01/01/2010","3/15/2016","Education","pdc","Organization"

var timeElements = function(dataset) {
  // bars

  var bars = d3.select("svg")
    .append("g")
    .selectAll("rect")
    .data(theseBands)
    .enter()
    .append("rect")
    .filter(function(d) {return d.typeis !== 'Political Party'})
    .attr({
      "x": dxStart,
      "y": htimeline + paddingdoc + margintop, // to move from top to bottom
      "height": function(d) {return d.dy; }, //meaning d.dy??
      "width": function(d) {return d.end - d.start; },
      "fill": sectorfill,
      "class": function(d) {return "bar-" + d.sector.replace(/\W/gi, '-').toLowerCase()},
      "id": function(d) {
        idcounterbar += 1;
        return "bar-" + idcounterbar; },
      "visibility": "hidden",
      "pointer-events": "visible" // can only be targeted when visibility is set to visible
    })
    ;

  
    //triangles

    theseBands
      .filter(function(b) {
        return b.typeis !== 'Political Party';
      })
      .forEach(function(d) {
    
        var xPoint = ((d.end - d.start)/ 2) + d.start + paddingdoc + marginleft; // x top-triangle point
        var yPoint =  htimeline - ((d.end - d.start)/ 2)  + paddingdoc + margintop ;  // y top triangle point
        var dxStart = d.start + paddingdoc + marginleft;// startpoint bar plus extra left padding
        var dyBar = htimeline + margintop + paddingdoc ; // to move from top to bottom
        var dxEnd = d.end + paddingdoc + marginleft; // endpoint bar

        var trianglePoints = [ { "x": dxStart,   "y": dyBar},  { "x": xPoint,   "y": yPoint}, { "x": dxEnd,   "y": dyBar} ];

        var lineFunction = d3.svg.line()
        .x(function(d) { return d.x; })
        .y(function(d) { return d.y; })
        .interpolate("linear"); // straight lines

        var triangle = d3.select("svg")
          .append("g")
          .selectAll("lines")
          .data([d])
          .enter()
          .append("path")
          .attr({
            "d": lineFunction(trianglePoints),
            "stroke": sectorfill,
            "stroke-width": 1,
            "fill-opacity": 0,
            "class": function(d) {return "tri-" + d.sector.replace(/\W/gi, '-').toLowerCase()},
            "id": function(d) {
              idcountertri += 1;
              return "tri-" + idcountertri; 
              },
            "visibility": "hidden",
            "pointer-events": "visible" // can only be targeted when visibility is set to visible
            })
          .style({
            "stroke-dasharray": ("3, 3"),
            "opacity": 0.4
          })
          ;
      })
    ;


    // dots

    var dots = d3.select("svg")
      .append("g")
      .selectAll("circle")
      .data(theseBands)
      .enter()
      .append("circle")
      .filter(function(d){return d.typeis !== 'Political Party'})
      .style({
        "opacity": 0,
      })
    ;

// transition werkt niet...

    dots.transition()
       .delay(function(d, i) {
        return i * 1000;
        })
      .duration(3000)
      // .ease("linear")
    ;

    var show = ["#bar-", "#tri-"]
    var showpp = ["#txtpp-"]
    var tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    dots
      .style({
        "opacity": 1,
        "cursor" : "pointer",
        "z-index": "10"
      })
      .attr({
        "r": radius, //radius
        "cx": xPoint, // startpoint
        "cy": yPoint, // positioning
        "fill": sectorfill,
        "class": function(d) {return "dot-" + d.sector.replace(/\W/gi, '-').toLowerCase()},
        "id": function(d) {
              idcounterdot += 1;
              return "dot-" + idcounterdot; 
            },
        "pointer-events": "visible" // can only be targeted when visibility is set to visible
          })
      .on("mouseover", function(d) {
          tooltip.transition()
            .duration(200)
            .style("opacity", .9);

          var format = d3.time.format("%d/%m/%Y");
          tooltip.html("<p class='bgtexttime'>Company: " + d['company'] + " <br/> Position: " + d['positionis'] + " <br/> Period: " + format(new Date(d['originalStart'])) + " - " + format(new Date(d['originalEnd'])) + " <br/> Source: " + d['sourceis'] + "</p>");
          //triangle and bar
          var active = this.active ? true : false;
          var visibility = active ? "hidden" : "visible";
          var obj = this.id.substr(4,5);
          show.forEach(function(s){
            d3.select(s + obj).each(function() {  
            this.setAttribute("visibility", visibility);
            });
          });
      })
      .on("mousemove", function(d){
        tooltip.style("left", (d3.event.pageX + 5) + "px")
            .style("top", (d3.event.pageY - 85) + "px");
      })
      .on("mouseout", function(d) {
        tooltip.transition()
          .duration(500)
          .style("opacity", 0);
          // triangle and bar
          var active = this.active ? true : false;
          var visibility = active ? "visible" : "hidden";
          var obj = this.id.substr(4,5);
          show.forEach(function(s){
            d3.select(s + obj).each(function() {  
            this.setAttribute("visibility", visibility);
            });
          });
      })

      ;

    //texttimeline
    /*
    var texttimeline = d3.select("svg")
      .append("g")
      .selectAll("text")
      .data(theseBands)
      .enter()
      .append("foreignObject")
      .filter(function(d) {return d.typeis !== 'Political Party'})
      .html(function(d) {
        return "<p class='bgtexttime'>Company: " + d.company + " <br/> Position: " + d.positionis + "</p>";
        })
      .attr({
        "x": xPoint,
        "y": yPoint,
        "fill": d3.rgb("#000"),
        "class": function(d) {return "txt-" + d.sector.replace(/\W/gi, '-').toLowerCase()},
        "id": function(d) {
          idcountertxt += 1;
          return "txt-" + idcountertxt; },
          "visibility": "hidden",
          "pointer-events": "visible" // can only be targeted when visibility is set to visible
      })
      .style({
        "z-index": "20",
        "position": "absolute"
      })
      .each(function(d) {
        var bbox = this.getBBox();

        d3.select(this.parentNode)
          .insert("rect", "text")
          // .style("fill", "#FFF")
          // .style("stroke-width", 1)
          // .style("stroke", "#000")
          // .attr("x", bbox.x )
          // .attr("y", bbox.y )
          .attr("width", bbox.width + 1) 
          .attr("height", bbox.height + 1);
      })
      ;
*/
      // political party bars

    var barparty = d3.select("svg")
      .append("g")
      .selectAll("rect")
      .data(theseBands)
      .enter()
      .append("rect")
      .filter(function(d) {return d.typeis === 'Political Party'})
      .attr({
        "x": dxStart,
        "y": function(d) {return 40 + htimeline + margintop + paddingdoc + d.y}, // positioning bars below each other in one category function (d) {return (h - d)}
        "height": function(d) {return d.dy; }, //
        "width": function(d) {return d.end - d.start; },
        "fill": d3.rgb("#AAA"),
        "id": function(d) {
              idcounterbarpp += 1;
              return "barpp-" + idcounterbarpp; 
            },
        "pointer-events": "visible"
      })
      .on("mouseover", function(d) {
          tooltip.transition()
            .duration(200)
            .style("opacity", .9);
          
          var format = d3.time.format("%d/%m/%Y");
          tooltip.html("<p class='bgtexttime'>Company: " + d['company'] + " <br/> Position: " + d['positionis'] + " <br/> Period: " + format(new Date(d['originalStart'])) + " - " + format(new Date(d['originalEnd'])) + " <br/> Source: " + d['sourceis'] + "</p>");

        var active = this.active ? true : false;
        var visibility = active ? "hidden" : "visible";
        var obj = this.id.substr(6,7);
        showpp.forEach(function(s){
          d3.select(s + obj).each(function() {  
          this.setAttribute("visibility", visibility);
          });
        });
      })
      .on("mousemove", function(d){
        tooltip.style("left", (d3.event.pageX + 5) + "px")
            .style("top", (d3.event.pageY - 30) + "px");
      })
      .on("mouseout", function(d) {
        tooltip.transition()
          .duration(500)
          .style("opacity", 0);

        var active = this.active ? true : false;
        var visibility = active ? "visible" : "hidden";
        var obj = this.id.substr(6,7);
        showpp.forEach(function(s){
          d3.select(s + obj).each(function() {  
          this.setAttribute("visibility", visibility);
          });
        });
      })
      ;

    //text political party info

    // var infoparty = d3.select("svg") 
    //   .append("g")
    //   .selectAll("text")
    //   .data(theseBands)
    //   .enter()
    //   .append("foreignObject")
    //   .filter(function(d) {return d.typeis === 'Political Party'})
    //   .html(function(d) {
    //     return "<p class='bgtexttime'>Political Party: " + d.company + " <br/> Position: " + d.positionis + "</p>";
    //     })
    //   .attr({
    //     "x": (function(d) {return (d.end - d.start) / 2 + d.start + paddingdoc + marginleft }),
    //     "y": (function(d) {return 47 + htimeline + margintop + paddingdoc + d.y - 3}),
    //     "id": function(d) {
    //           idcountertxtpp += 1;
    //           return "txtpp-" + idcountertxtpp; 
    //         },
    //     "visibility": "hidden",
    //     "pointer-events": "visible"
    //   })
    //   .style({
    //     "opacity": 1
    //   })
    //   .each(function(d) {
    //     var bbox = this.getBBox();

    //     d3.select(this.parentNode)
    //       .insert("rect", "text")
    //       .attr("width", bbox.width + 1) 
    //       .attr("height", bbox.height + 1);
    //   })
    //   ;


} // end timeElements

var timeLegend = function(dataset) { // legend
// todo: check if domain is not empty (because of moving the political party items)
  
  var legendRectSize = 15;
  var legendSpacing = 5;

  var legendtitle = d3.select("svg")
    .append("text")
    .text("Sectors")
    .attr({
      "class": "legendtitle",
      "x": paddingdoc,
      "y": paddingdoc + margintop + 6
    })
  ;

  var legendexplain = d3.select("svg")
    .append("text")
    .text("Click to show/hide")
    .attr({
      "class": "legendexplain",
      "x": paddingdoc,
      "y": paddingdoc * 2 + margintop
    })
  ;

  var legend = d3.select("svg")
    .append("g")
    .selectAll("g")
    .data(colorScale.domain())
    .enter()
    .append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) {
        var height = legendRectSize;
        var x = paddingdoc;
        var y = (paddingdoc * 2.5) + i * (height + legendSpacing) + margintop;
        return "translate(" + x + "," + y + ")";
      })
    .on("mouseover", function(d){
      d3.select(this)
      .each(function(){
        this.style.opacity = 0.6;
      });
    })
    .on("mouseout", function(d){
      var active = this.active ? true : false;
      var opacityItem = active ? 0.3 : 1;
      d3.select(this)
      .each(function(){
        this.style.opacity = opacityItem;
      });
    })
    .on("click", function(d) {
      var active = this.active ? true : false;
      var opacityDots = active ? 1 : 0;
      var opacityItem = active ? 1 : 0.3;
      var visibility = active ? "visible" : "hidden";
      this.active = !active;
      d3.selectAll('.dot-' + d.replace(/\W/gi, '-').toLowerCase())
      .each(function() {
        this.style.opacity = opacityDots;
        this.setAttribute("visibility", visibility);
      });
      d3.select(this)
      .each(function(){
        this.style.opacity = opacityItem;
      });
    })
    ;

  legend.append("rect")
    .attr("width", legendRectSize)
    .attr("height", legendRectSize)
    .style("fill", colorScale)
    .style("stroke", colorScale)
    ;

  legend.append("text")
    .attr("x", legendRectSize + legendSpacing)
    .attr("y", legendRectSize - legendSpacing + 2)
    .text(function(d) { return d; })
    
    ;

} // end timeLegend

// draw everything on the page

d3.csv("cvbruijn.csv", function (dataset) {

  var determineSector = sectorTypes(dataset);

  var drawAxes = timeAxes(dataset);

  //DRAW ELEMENTS: points, timelines, text connected to the points
  types.forEach(function(type, i) {
    onlyThisType = dataset.filter(function(d) {return d.sector === type});
    theseBands = timeline(onlyThisType);

    var drawElements = timeElements(dataset);

  });

  var drawLegend = timeLegend(dataset);

});

</script>
</head>
<body>
<div id="viz">
  <h1>Timeline Jan Anthonie Bruijn</h1>

</div>
</body>
</html>
